import { Head, Notes, Image } from 'mdx-deck'
import Split from './src/Split'

export { theme } from './theme'

<Head>
  <title>BDD workshop</title>
</Head>

# Multi layer
# Outside in
# BDD
_Behaviour Driven Development_
# For modern rails apps

<Notes>
  <ul>
    <li>rails conf 2019</li>
    <li>with colleague Selena Small</li>
    <li>real demo mode</li>
  </ul>
</Notes>

---

## Modules

1. When Then steps
1. Page Fragments
1. Flows and Mechanics
1. Flakys
1. Drive new functionality through all the layers
1. How your tests will fail with refactors

---

# Modern rails app

- React SPA in places
- Admin and other rails views
- Rails backend as API
- Active record to DB
- dependency on external services

<Notes>
  <ul>
    <li>what it is</li>
  </ul>
</Notes>

---

# Tranditional view of testing

[Pyramid]

- UI tests
- Service layer Integration testing
- Traditional unit testing

<Notes>
  <ul>
    <li>happy case at the top</li>
    <li>integration testing</li>
    <li>unit as "isolated" unit</li>
    <li>number of tests at each layer</li>
  </ul>
</Notes>

---

# BDD
_Behaviour Driven Development_

<Notes>
  <ul>
    <li>test behaviour not implementation</li>
  </ul>
</Notes>

---

<Image
  style={{ width: '40vw', height: '70vh' }}
  src="https://cdn-images-1.medium.com/max/1600/1*SLmk-xp-dv7aS8XLabqlwA.gif"/>

<br />

<div style={{ fontSize: '0.7em' }}>
  https://medium.com/@Cyrdup/unit-testing-youre-doing-it-wrong-407a07692989
</div>

<Notes>
  <ul>
    <li>you want your code to have a use</li>
    <li>unit testing in isolation does not always do the trick</li>
  </ul>
</Notes>

---

# outside in

_layered like an onion_

* UI Flows
  * core business
* Page mechanics
  * possible interactions with a page
* Frontend Component Tests
* API Integration
* service layer tests
* Controller Unit
* Domain logic

<Notes>
  <ul>
    <li>Flows multi step with flow on effects</li>
    <li>Mechanics possible interactions expected and unexpected</li>
    <li>all are unit tests, boundary of units</li>
    <li>Key is an organisation of tests</li>
    <li>UI flow should describe a system</li>
  </ul>
</Notes>

---

# Module 1
## When Then steps

---

# Traditional Testing Scenario

|           |                                      |             |
|:--------- |:-------------------------------------|:----------- |
| **Given** | IMAGE<br />nail and hammer raised         | **Arrange** |
| **When ** | IMAGE<br />hammer strikes nail            | **Act    ** |
| **Then ** | IMAGE<br />nail goes into timber          | **Assert ** |

<Notes>
  <ul>
    <li>made up of these state, GWT</li>
    <li>Good points</li>
    <li>Limitations</li>
    <ul>
      <li>assumes the given setup is accurate to the behaviour of your app</li>
      <li>not case in real life</li>
      <li>user behaviour is not a 1 shot</li>
      <li>number of actions</li>
      <li>often a number of actors</li>
    </ul>
  </ul>
</Notes>

---

# Drop the Given

* ~~Given~~
* When
* Then

<Notes>
  <ul>
    <li>and get there through When Then steps</li>
  </ul>
</Notes>

---

* When
* Then


* When
* Then


* When
* Then

<Notes>
  <ul>
    <li>transition errors</li>
    <li>Given ties us to mocking implementation without testing it's integration</li>
  </ul>
</Notes>

---

# Example - signup to instagram

---

* **When** User of the internet visits instagram for a first time
* **Then** I am shown login and signup details

<div style={{ height: '60vh', width: '100%' }}>
{/* TODO: why do I need the width="30vw" below? */}
<Image
  width="30vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/01_insta_visit.png')} />
</div>

---

* **When** I signup with
  * "Michael, saramic+2@gmail.com, saramic2020"
* **Then** I am encouraged to turn on notifcations

<div style={{ height: '60vh', width: '100%', display: 'flex' }}>
<Image
  width="30vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/02_insta_fillin.png')} />
<Image
  width="30vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/03a_insta_notifications.png')} />
</div>

---

* **When** I click _"Not Now"_
* **Then** I am on suggested people to follow page

<div style={{ height: '60vh', width: '100%', display: 'flex' }}>
<Image
  width="30vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/03a_insta_notifications.png')} />
<Image
  width="30vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/03_insta_recommend.png')} />
</div>

---

* **When** I follow instagram, mileycyrus, justinbieber
* **Then** It shows I am following them

<div style={{ height: '60vh', width: '100%', display: 'flex' }}>
<Image
  width="30vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/03_insta_recommend.png')} />
<Image
  width="30vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/04_insta_follow.png')} />
</div>

---

* **When** I click _"Get Started"_
* **Then** I am encouraged to add my phone and connect through Facebook
* **And** I have stories from people I follow
* **And** I have suggestions
* **And** I have a feed of posts from people I follow
* **And** I have search, explore, activity, profile links at the top

<div style={{ display: 'flex', maxWidth: '80vw', maxHeight: '40vw' }}>
<Image
  style={{ width: '25vw', maxHeight: '40vh' }}
  src={require('file-loader!./images/05_insta_get_started_link.png')} />

<Image
  style={{ width: '25vw', maxHeight: '40vh' }}
  src={require('file-loader!./images/06_insta_feed_page.png')} />

<Image
  style={{ width: '25vw', maxHeight: '40vh' }}
  src={require('file-loader!./images/07_insta_recommend_in_feed.png')} />
</div>

---

* **When** Email job is run
* **Then** User recieves the email
<div style={{ height: '60vh', width: '100%', display: 'flex' }}>
<Image
  width="80vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/08_insta_email.png')} />
</div>

---

* **When** click email link _"Confirm your email address"_
* **Then** User is taken to the site with alert _"You have successfully confirmed your email"_

<div style={{ height: '60vh', width: '100%', display: 'flex' }}>
<Image
  width="26vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/09_insta_email_content.png')} />
<Image
  width="30vw"
  style={{ maxHeight: '100%', maxWidth: '100%' }}
  src={require('file-loader!./images/10_insta_confirm_email.png')} />
</div>

---

# _"When" "Then"_ flows through the system

[IMAGE?]

---

# Happy path integration?

[IMAGE?]

---

# Other flows?

- what if username is taken?
- what happens if you turn notifications on?
- what if you do not follow anyone?

---

# Hey but there was a Given!

* what was the Given? (Arranged state)

<Notes>
  <ul>
    <li>GIVEN instagram has users</li>
    <li>AND users are promoted to be followed</li>
    <li>For this we will use a CONTEXT</li>
  </ul>
</Notes>

---

# let's bring back the Given

as a context
- context a user is signed up to insagram following 3 users

---

* **Context** instagram has users
* **And** some users are promoted to be recommended to be followed
* **When** User of the internet visits instagram for a first time
* **Then** ...

---

# Why not do each of these actions as Given, When, Then?

[core concpets!!!]

---

# Other tests?

- form not filled in?
- password too weak?
- don't follow anyone?
- notification modal yes/no?

---

# What about more detail

- email invalid
- forgot to enter madatory fields
- got an error in submission
- username suggest not working

* NOT IN FLOW - Next layer down
- split into page mechanics

---

# And even more detail

- reusable form compnents?
- validation on length of handle
- valid characters for handle
- spinners and loading effects

* NOT IN FLOW - Another layer down
- "unit" tests

---

# Your turn

- explore?
- like?
- stories?
- profile?

---

# A demo app

<iframe frameborder="0" width="1400" height="600" src="http://localhost:3000/"></iframe>

- what is the flow?
- what could be the mechanics?

---

# Your turn

- write a flow for a user wants to play and needs a profile

---

# Let's take a look

_code dive_

<Notes>
<ul>
<li>straight out rspec</li>
<li>add when then steps</li>
<li>pull out page fragments</li>
</ul>
</Notes>

---

# A second flow that is broken

_with extension_

---

# Module 1 Review
## When Then steps

* mutlipe When Then actions add up to a flow
* `rspec-wait` helps organise `RSpec` tests
* _Key things that this will catch_
* _How to organise scenarios_

---

# Module 2
## Page Fragments

---

# What is a page fragment? (presentation)

- Often referred to as a page model
- A selenium test suite with capybara running the browser operates by executing browser actions written in code
- These actions are required to run the tests but they’re not important to the tests themselves
- And as tests act as a way for documenting behaviours of a system, you want to avoid convoluting them
- Hiding away these actions into what we’ve come to know as page fragments helps keep tests cleaner, more readable and less fragile to change in the future

---

# Why are they useful? (presentation)

- Changing text on element identified by className or data-attribute means your tests don’t break
- Changing className on an element means you only make an update to one fragment method in one place and all your tests still pass

---

# Where do they belong in your code base? (presentation)

- along with the rest of your test suite, it makes sense to keep them under spec directory. And as supporting materials for feature tests, you might expect to find them in a similarly named directory
- spec/support/features

---

# How are they available in tests? (presentation)

- module PageFragments included in rspec.config
- config.include PageFragments, type: :feature
- Where do the browser methods come from?

---

# Developer tools (example)

- Element hierarchy - semantic html
- Find elements in the browser

---

# Facebook (exercise)

- Identify generic elements

---

# Dashboard website (exercise)

- Find specific elements
- See how they are generic
- Pseudo construct fragment methods for those elements
    - How to write them
    - How to use them

---

# Making assertions (presentation)

- Rules of asserting elements
- Synchronise method
- has_no_css
- to_not be_present

---

# Our app (exercise)

- Hide away basic fragments

---

# OO Design patterns (exercise)

- What does re-usability mean
- Why is re-usability important
- Patterns of reusable fragments
- Abstract reusable fragments

---

# Benefits of page fragments (example)

- Changing text on element identified by className or data-attribute means your tests don’t break
- Changing className on an element means you only make an update to one fragment method in one place and all your tests still pass

---

# Module 3
## Flows and Mechanics

---

# Module 4
## Flakys

---

# Module 5
## Drive new functionality through all the layers

---

# Module 6
## How your tests will fail with refactors

---

<https://github.com/failure-driven/game-app>

